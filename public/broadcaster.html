<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Orbits Broadcaster</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #000000;
      --text: #ffffff;
      --text-dim: rgba(255, 255, 255, 0.5);
      --border: rgba(255, 255, 255, 0.1);
      --accent: #2563eb;
      --danger: #ef4444;
      --success: #10b981;
    }

    * { box-sizing: border-box; }
    
    body {
      margin: 0;
      height: 100vh;
      font-family: -apple-system, BlinkMacSystemFont, "Inter", sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .container {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 16px;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
    }

    /* Minimalist Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .brand {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-badge {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 99px;
      background: rgba(255,255,255,0.08);
      color: var(--text-dim);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-dim);
    }
    
    .status-badge.live { background: rgba(16, 185, 129, 0.1); color: var(--success); }
    .status-badge.live .status-dot { background: var(--success); box-shadow: 0 0 8px var(--success); }

    /* Controls Grid */
    .controls {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
    }

    select {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 13px;
      outline: none;
      width: 100%;
      cursor: pointer;
    }

    .button-group {
      display: flex;
      gap: 8px;
    }

    button {
      background: rgba(255,255,255,0.08);
      border: none;
      color: var(--text);
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover:not(:disabled) { background: rgba(255,255,255,0.15); }
    button:disabled { opacity: 0.4; cursor: not-allowed; }

    button.primary { background: var(--text); color: black; }
    button.primary:hover:not(:disabled) { background: #e5e5e5; }

    /* Transcript Area */
    .transcript-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
      position: relative;
    }

    textarea {
      flex: 1;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      color: var(--text);
      font-size: 14px;
      line-height: 1.6;
      resize: none;
      outline: none;
      width: 100%;
    }

    textarea::placeholder { color: var(--text-dim); }

    /* Utilities */
    .logs {
      font-size: 11px;
      color: var(--text-dim);
      font-family: monospace;
      padding: 8px;
      border-top: 1px solid var(--border);
      max-height: 60px;
      overflow-y: auto;
    }
    
    #screenPreview {
      display: none;
      width: 120px;
      height: 68px;
      border-radius: 8px;
      border: 1px solid var(--border);
      object-fit: cover;
      position: absolute;
      bottom: 24px;
      right: 24px;
      background: black;
      z-index: 10;
    }

    /* Hidden Select Elements if minimal */
    .hidden { display: none; }
  </style>
</head>
<body>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="brand">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5 10 10 0 0 0-10 10 10 10 0 0 0 10 10z"/></svg>
        Broadcaster
      </div>
      <div id="statusBadge" class="status-badge">
        <span class="status-dot"></span>
        <span id="statusText">Idle</span>
      </div>
    </div>

    <!-- Minimal Controls -->
    <div class="controls">
      <div style="display:flex; gap:8px;">
        <select id="sourceLang" style="max-width: 180px;" aria-label="Input Language"></select>
        <select id="audioSource" style="max-width: 140px;" aria-label="Audio Source">
           <option value="screen" selected>Screen Audio</option>
           <option value="mic">Microphone</option>
        </select>
      </div>
      <div class="button-group">
        <button id="shareBtn">Share Screen</button>
        <button id="startBtn" class="primary">Start</button>
        <button id="stopBtn" disabled>Stop</button>
      </div>
    </div>

    <!-- Transcript -->
    <div class="transcript-container">
      <textarea id="transcript" placeholder="Transcript will appear here in real-time..." readonly></textarea>
      <video id="screenPreview" autoplay muted playsinline></video>
    </div>

    <!-- Logs -->
    <div class="logs" id="log"></div>
  </div>

  <script>
    // ==========================
    // Configuration
    // ==========================
    const SUPABASE_URL = "https://bridhpobwsfttwalwhih.supabase.co";
    const SUPABASE_KEY = "sb_publishable_fc4iX_EGxN1Pzc4Py_SOog_8KJyvdQU";

    // Initialize Supabase
    let supabaseClient = null;
    try {
      const { createClient } = window.supabase;
      supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (err) {
      console.error("Supabase init failed", err);
    }

    // State
    const ANON_CLIENT_ID_KEY = "eburon_anon_client_id";
    let anonClientId = localStorage.getItem(ANON_CLIENT_ID_KEY);
    if (!anonClientId) {
      anonClientId = crypto.randomUUID ? crypto.randomUUID() : "client-" + Date.now();
      localStorage.setItem(ANON_CLIENT_ID_KEY, anonClientId);
    }
    
    // Meeting ID Resolution
    function resolveMeetingId() {
      try {
        const params = new URLSearchParams(window.location.search);
        return params.get("meeting_id") || localStorage.getItem("eburon_last_meeting_id") || "standalone-" + anonClientId;
      } catch { return "error-" + anonClientId; }
    }
    const meetingId = resolveMeetingId();
    localStorage.setItem("eburon_last_meeting_id", meetingId);

    // DOM Elements
    const logEl = document.getElementById("log");
    const statusBadge = document.getElementById("statusBadge");
    const statusText = document.getElementById("statusText");
    const transcriptEl = document.getElementById("transcript");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const shareBtn = document.getElementById("shareBtn");
    const screenPreview = document.getElementById("screenPreview");
    const sourceLangSelect = document.getElementById("sourceLang");
    const audioSourceSel = document.getElementById("audioSource");

    function log(msg) {
      logEl.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    }

    // ==========================
    // Core Logic
    // ==========================
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;
    let stopRequested = false;
    let saveInterval = null;
    let lastSavedText = "";
    let fullTranscript = "";

    function setUI(running) {
      if (running) {
        statusBadge.classList.add("live");
        statusText.textContent = "Live";
        startBtn.disabled = true;
        stopBtn.disabled = false;
        shareBtn.disabled = true;
        audioSourceSel.disabled = true;
        sourceLangSelect.disabled = true;
        if(audioSourceSel.value === 'screen') screenPreview.style.display = "block";
      } else {
        statusBadge.classList.remove("live");
        statusText.textContent = "Idle";
        startBtn.disabled = false;
        stopBtn.disabled = true;
        shareBtn.disabled = false;
        audioSourceSel.disabled = false;
        sourceLangSelect.disabled = false;
         screenPreview.style.display = "none";
      }
    }

    // Languages
    const LANGUAGES = [
      { code: "", label: "âœ¨ Auto-detect" },
      { code: "en-US", label: "English" },
      { code: "es-ES", label: "Spanish" },
      { code: "fr-FR", label: "French" },
      { code: "de-DE", label: "German" },
      { code: "zh-CN", label: "Chinese" },
      { code: "ja-JP", label: "Japanese" },
      { code: "fil-PH", label: "Filipino (Tagalog)" },
      { code: "ceb-PH", label: "Cebuano (Bisaya)" },
      { code: "ilo-PH", label: "Ilocano" },
      { code: "hil-PH", label: "Hiligaynon (Ilonggo)" }
    ];
    LANGUAGES.forEach(l => {
      const opt = document.createElement("option");
      opt.value = l.code;
      opt.textContent = l.label;
      sourceLangSelect.appendChild(opt);
    });

    // Screen Share
    async function startScreenShare() {
      try {
        const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
        screenPreview.srcObject = stream;
        log("Screen shared ready.");
      } catch (e) {
        log("Screen share cancelled.");
      }
    }
    shareBtn.onclick = startScreenShare;

    // Supabase Saving
    async function saveToSupabase(text) {
      if (!text || text === lastSavedText || !supabaseClient) return;
      
      // Auto-detect speakers (mock logic for minimal version or call API)
      let formattedText = text; 
      
      try {
        // Optimistic save
        await supabaseClient.from("transcripts").upsert({
          session_id: "sess-" + meetingId,
          meeting_id: meetingId,
          user_id: anonClientId,
          full_transcript_text: formattedText,
          updated_at: new Date().toISOString()
        }, { onConflict: "session_id" });
        
        lastSavedText = text;
      } catch (e) { console.error(e); }
    }

    function startSavingLoop() {
      if (saveInterval) clearInterval(saveInterval);
      saveInterval = setInterval(() => {
        saveToSupabase(fullTranscript);
      }, 5000); // 5s interval
    }

    // Speech Recognition
    function startListening() {
      if (!SpeechRecognition) return alert("Browser not supported");
      if (isListening) return;

      recognition = new SpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = sourceLangSelect.value || navigator.language || "en-US";

      recognition.onstart = () => {
        isListening = true;
        stopRequested = false;
        setUI(true);
        log("Listening started...");
        startSavingLoop();
      };

      recognition.onresult = (event) => {
        let interim = "";
        let final = "";

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final += event.results[i][0].transcript + " ";
          } else {
            interim += event.results[i][0].transcript;
          }
        }

        if (final) {
          fullTranscript += final;
        }
        
        transcriptEl.value = fullTranscript + (interim ? ` [${interim}]` : "");
        transcriptEl.scrollTop = transcriptEl.scrollHeight;
      };

      recognition.onerror = (e) => {
        if (e.error === 'aborted' && !stopRequested) return; // Ignore aborts if not requested
        log("Error: " + e.error);
        if (e.error === 'not-allowed') stopListening();
      };

      recognition.onend = () => {
        isListening = false;
        if (!stopRequested) {
          log("Restarting...");
          try { recognition.start(); } catch(e){}
        } else {
          setUI(false);
          log("Stopped.");
          if (saveInterval) clearInterval(saveInterval);
        }
      };

      try {
        recognition.start();
      } catch (e) {
        log("Start failed: " + e.message);
      }
    }

    function stopListening() {
      stopRequested = true;
      if (recognition) recognition.stop();
    }

    startBtn.onclick = startListening;
    stopBtn.onclick = stopListening;

    // Auto-start check
    const params = new URLSearchParams(window.location.search);
    if (params.get("autostart") === "true") {
      setTimeout(startListening, 1000);
    }

    // Dialect Resources (Knowledge Base)
    const DIALECT_RESOURCES = {
      "fil-PH": "https://www.tagalog.com/dictionary/",
      "ceb-PH": "https://www.binisaya.com/",
      "ilo-PH": "https://toidp.com/",
      "hil-PH": "http://www.hiligaynon.net/"
    };

    const resourceContainer = document.createElement("div");
    resourceContainer.style.cssText = "font-size:12px; color:var(--text-dim); margin-top:4px;";
    resourceContainer.id = "resourceLink";
    document.querySelector(".controls").firstElementChild.appendChild(resourceContainer);

    sourceLangSelect.addEventListener("change", () => {
      const url = DIALECT_RESOURCES[sourceLangSelect.value];
      if (url) {
        resourceContainer.innerHTML = `<a href="${url}" target="_blank" style="color:var(--accent);text-decoration:none;">ðŸ“š Dialect Dictionary</a>`;
      } else {
        resourceContainer.innerHTML = "";
      }
    });

  </script>
</body>
</html>
